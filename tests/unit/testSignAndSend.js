Ext.Loader.setConfig({    enabled: true,    disableCaching: false});Ext.data.proxy.Server.prototype.noCache = false;Ext.Ajax.disableCaching = false;new TestCase('SignAndSend', {    setUp: function () {        this.server = sinon.fakeServer.create();        Ext.Msg.alert = Ext.emptyFn;        Ext.Msg.error = function (msg, func) { func(); };        Ext.Msg.progress = Ext.emptyFn;        Ext.global.baseUrl = '/';        // TODO: отступы - только пробелы, включить в IDE отображение пробелов        // TODO: написать тест на случай если не указано значение в куках        Ext.util.Cookies.set('currentCert', 'test');        this.service = Ext.create('COURIERONLINE.services.SignAndSend');        this.service.getCryptoService().generateSign = function (data, callback) {            callback('111');        };        this.clock = sinon.useFakeTimers();    },    tearDown: function () {        this.server.restore();    },    testIsCookie: function () {        if ((Ext.util.Cookies.get('currentCert') === '') || (Ext.util.Cookies.get('currentCert') === null)) {            Ext.util.Cookies.set('currentCert', 'test');        }        assertNotNull(Ext.util.Cookies.get('currentCert'));    },    testCreate: function () {        assertNotUndefined(this.service);        assertNotNull(this.service);        assertInstanceOf(COURIERONLINE.services.SignAndSend, this.service);    },    testSignEmptyParam: function () {        var failClb = sinon.spy();        var doneClb = sinon.spy();        this.service.signAndSend([]).fail(failClb).done(doneClb);        this.clock.tick(1);        assertFalse(doneClb.called);        assertTrue(failClb.called);        assertTrue(failClb.calledOnce);        assertTrue(failClb.calledWith('Не выбраны документы'));    },    testSignWithoutParam: function () {        var failClb = sinon.spy();        var doneClb = sinon.spy();        this.service.signAndSend().fail(failClb).done(doneClb);        this.clock.tick(1);        assertFalse(doneClb.called);        assertTrue(failClb.called);        assertTrue(failClb.calledOnce);        assertTrue(failClb.calledWith('Не выбраны документы'));    },    'testSign_Error_GetPackets': function () {        var failClb = sinon.spy();        var doneClb = sinon.spy();        this.service.signAndSend(['123456']).fail(failClb).done(doneClb);        this.fetchDocsForSign(500, '');        assertFalse(doneClb.called);        assertTrue(failClb.called);        assertTrue(failClb.calledOnce);        assertTrue(failClb.calledWith('Ошибка получения данных по выбранным документам'));    },    'testSign_NoData_GetPackets': function () {        var failClb = sinon.spy();        var doneClb = sinon.spy();        this.service.signAndSend(['123456']).fail(failClb).done(doneClb);        this.fetchDocsForSign(200, '');        assertFalse(doneClb.called);        assertTrue(failClb.called);        assertTrue(failClb.calledOnce);        assertTrue(failClb.calledWith('Нет данных по выбранным документам'));    },    'testSign_EmptyData_GetPackets': function () {        var failClb = sinon.spy();        var doneClb = sinon.spy();        this.service.signAndSend(['123456']).fail(failClb).done(doneClb);        this.fetchDocsForSign(200, '[]');        this.clock.tick(1);        assertFalse(failClb.called);        assertTrue(doneClb.called);        assertTrue(doneClb.calledOnce);        assertTrue(doneClb.calledWith('Выбранные документы уже подписаны'));    },    'testSign_SignEmptyPacket': function () {        var failClb = sinon.spy();        var doneClb = sinon.spy();        this.service.signAndSend(['123456']).fail(failClb).done(doneClb);        this.fetchDocsForSign(200, Ext.encode([            {id: '123456', docs: []}        ]));        this.service.okClick();        this.clock.tick(1);        this.server.respondWith('POST', '/?action=invoke&mth=sendPackets&obj=docRoutes', [200, {  }, '']);        this.server.respond();        assertFalse(failClb.called);        assertTrue(doneClb.called);        assertTrue(doneClb.calledOnce);    },    'testSign_SignNotEmptyPacket': function () {        var failClb = sinon.spy();        var doneClb = sinon.spy();        this.service.signAndSend(['123456']).fail(failClb).done(doneClb);        this.respondWithValidPacketData();        this.service.okClick();        this.clock.tick(1);        this.responseDocData();        this.clock.tick(100); // подписываем документ        this.sendSign();        this.clock.tick(1);        this.sendPackets(200);        assertFalse(failClb.called);        assertTrue(doneClb.called);        assertTrue(doneClb.calledOnce);    },    'testSign_ErrorOnSendPackets': function () {        var failClb = sinon.spy();        var doneClb = sinon.spy();        this.service.signAndSend(['123456']).fail(failClb).done(doneClb);        this.respondWithValidPacketData();        this.service.okClick();        this.clock.tick(1);        this.responseDocData();        this.clock.tick(100); // подписываем документ        this.sendSign();        this.clock.tick(1);        this.sendPackets(500);        assertFalse(doneClb.called);        assertTrue(failClb.called);        assertTrue(failClb.calledOnce);        assertTrue(failClb.calledWith('Ошибка при отправке документов'));    },    'testSign_SignNotEmptyPacket_WithInvalidDoc': function () {        var failClb = sinon.spy();        var doneClb = sinon.spy();        this.service.signAndSend(['123456']).fail(failClb).done(doneClb);        this.respondWithValidPacketData();        this.service.okClick();        this.clock.tick(1);        this.responseDocData(''); // пустой документ        this.clock.tick(1);        assertTrue(failClb.called);        assertTrue(failClb.calledOnce);        assertFalse(doneClb.called);    },    'testSign_SignNotEmptyPacket_CannotGetDocumentContent': function () {        var failClb = sinon.spy();        var doneClb = sinon.spy();        this.service.signAndSend(['123456']).fail(failClb).done(doneClb);        this.respondWithValidPacketData();        this.service.okClick();        this.clock.tick(1);        this.responseDocData('', 500); // серверная ошибка        this.clock.tick(1);        assertFalse(doneClb.called);        assertTrue(failClb.called);        assertTrue(failClb.calledOnce);        assertTrue(failClb.calledWith('Ошибка при подписи некоторых документов'));        assertEquals(failClb.args[0][1], [            {'id': '123456', 'docs': []}        ]);    },    'testSign_SignNotEmptyPacket_ErrorOnAddSign': function () {        var failClb = sinon.spy();        var doneClb = sinon.spy();        this.service.signAndSend(['123456']).fail(failClb).done(doneClb);        this.respondWithValidPacketData();        this.service.okClick();        this.clock.tick(1);        this.responseDocData();        this.clock.tick(100); // подписываем документ        this.sendSign(500);        this.clock.tick(1);        assertFalse(doneClb.called);        assertTrue(failClb.called);        assertTrue(failClb.calledOnce);        assertTrue(failClb.calledWith('Ошибка при подписи некоторых документов'));        assertEquals(failClb.args[0][1], [            {'id': '123456', 'docs': []}        ]);    },    fetchDocsForSign: function (code, data) {        this.server.respondWith('GET',            '/?action=invoke&mth=getDocsForSign&obj=docRoutes&ids=%5B%22123456%22%5D', [                code ? code : 200, {  }, Ext.isDefined(data) ? data : ''            ]        );        this.server.respond();    },    respondWithValidPacketData: function () {        this.fetchDocsForSign(200, Ext.encode([            {id: '123456', docs: [                {id: '123', name: 'qqqq'}            ]}        ]));    },    // получение контента документа    responseDocData: function (data, code) {        this.server.respondWith('GET', '/?action=invoke&mth=getDocContent&obj=docRoutes&id=123', [            Ext.isDefined(code) ? code : 200,            {  },            Ext.encode({data: Ext.isDefined(data) ? data : '11111111111111111'})        ]);        this.server.respond();    },    // отправка подписи    sendSign: function (code) {        this.server.respondWith('POST', '/?action=invoke&mth=addDocSignature&obj=docRoutes', [            Ext.isDefined(code) ? code : 200, {  }, ''        ]);        this.server.respond();    },    sendPackets: function (code) {        this.server.respondWith('POST', '/?action=invoke&mth=sendPackets&obj=docRoutes', [            code || 200, {  }, ''        ]);        this.server.respond();    }});